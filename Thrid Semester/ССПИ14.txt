================================================
                    ССПИ14 - 15
================================================
Протокол STP
STP - Spanning Tree Protocol
broadcast storm - явления заключающееся в бесконечном создании broadcast-запросов в кольце комутаторов. Broadcast-storm способен вывести из строя целую сеть.
Заполняет канал и не позволяет подключится через SSH/telnet. Является распространённой атакой на сети.
Таким образом STP решает проблему петлей комутации.

Нестабильность базы MAC-адресов - постоянная перезапись базы MAC-адресов, возникающая с двухсторонним принятием ARP-reply с MAC-адреса и его дальнейшей перезаписи в 
таблице ARP. Это может являтся (и является) причиной повторной отправки кадров.

Протокол STP блокирует определенные порты и разрывает петлю.
В основе протокола лежит "Алгоритм основного(покрывающего) дерева". Протокол был разработан Радьей Перлман. Протокол стандартизирован как IEEE802.1w в 1990.
В 2004 802.1w был модернизирован и вошёл в состав IEEE802.11D. Протокол STP является семейством протоколов и является частью стандарта IEEE802.1q.

Идея STP заключающется в том чтобы определить корневой комутатор и заблокировать остальные.
Root Bridge - роль комутатора являющаяся корнем.
Designated Bridge - роль комутатора которая выбираетеся на каждом сегменте. Роль отвечает за наиближайшее расположение к Root Bridge. Таким образом, на Root все порты
будут являтся Designated.
Чтобы добраться до Root, каждому комутатору необходимо выставить Port Priority Vector(PPV), то есть кратчайшую дорогу.

Кадром STP является BPDU - Bridge Protocol Data Unit, то есть единица данных bridge-протокола.
Каждый комутатор имеет уникальный BID - Bridge ID, состоящий из 64 бит. Он является двоиным числом состоящий из 16 бит - приоритет и 48 бит - MAC - адреса устройства.
Приоритет является более важной характеристикой для STP.
При включении комутатора блокируется полезная комутация, однако протокол STP продолжает работать.
Это вызвано тем что каждый комутатор по умолчанию считает что он Root. Определние Root происходит по BID, наименьший BID становится Root. После того как все комутаторы
получили свои роли, каждый из них строит свой PPV и отключают соответствующие линки. После этого процесса комутация возобновляется. 

После того как комутатор получает BPDU
BPDU состоит из заголовка, а именно:
Protocol ID - 0x0000
Protocol version - 0 (802.1d 80 Legacy) / 2 (802.1d 98 RSTP) / 3 (MSTP)
BPDU type - Configuration 0x00 (Вся необходимая информация) / TCN 0x80 (Topology Change Notificaton - сообщение об изменении топологии) / RST BPDU 0x02
Flags:
    Topology Change - смена топологии
    Proposal - запрос
    Port role - 00 - unknown / 01 - Alt/back / 10 - root / 11 - designated
    Learning - Learning - изучение / Forwarding - комутация
    Agreement - ответ
    Topology Change Acknowlegment - подтверждение смены топологии
BID Root-а - 8 байт,
RPC - Root Path Cost - 4 байта, это цена(длинна) пути до Root, каждый порт имеет некоторую стоимость, зависящую от пропускной способности(bandwitch) 
BID Sender-а - 8 байт,
Port ID Sender-а - 2 байта.
Hello time - 
Forward delay - таймер 

PPV:
Root BID - 8 байт
RPC - 4 байт
Sender BID - 8 байт
Sender Port ID - 2 байт

RPC, скорости соответствующие стандатам и их стоимость.

            802.1d(1990)      802.1d(1998)      802.1d(2004)
4   мбит    250               250               5 000 000
10  мбит    100               100               2 000 000
16  мбит    62                62                1 250 000
100 мбит    10                19                200 000
1   гбит    1                 4                 20 000
2   гбит    1                 3                 10 000
10  гбит    1                 2                 2 000

BPDU можно класифировать как Superior и Inferior, то есть худшая и лучшая BPDU соответственно.
Роли портов:
1. Root port - порт, на который пришёл лучший BPDU. Такой порт может существовать только в единственном экземпляре. Также он является работающим портом после
разблокировки комутации.
2. Alternate port(Alternate root - port) - запасной корневой порт, порт на который пришёл худший(по сравнению с Root port) BPDU. В отличии от Root port Alternate-port-ов
может быть несколько. Alternate-port находится в заблокированном состоянии.
3. Designated port - порт, на котором отправляется самые выгодные BPDU. На Root - устройстве все порты находятся в этом состоянии.  
4. Backup port - порт воткнутый в другой такой же порт этого устройства, необходим для получения своего же BPDU.

Состояния портов:
1. Disabled - порт выключен физически или на порту не работает STP.
2. Blocking - состояние порта во время смены топологии.
3. Listening - состояние прослушивания, комутация заблокирована. Длится в течении Forward delay (15 с.).
4. Learning - состояние изучения, комутация заблокирована. Длится в течении Forward delay (15 с.). В этом состоянии пополняется база MAC - адресов.
5. Forwarding - комутация осуществляется, MAC-Learning выполняется, трафик передаётся. 

STP вкладывается LLC.

802.1d, разработанный в 2004 году вводит новый стандарт названный Rapid STP или RSTP. RSTP обратно совместим с STP. Переход к RSTP состоялся в связи с отказам от
общей шины. 
Появился новый тип портов: Point-to-point - порт, смотрящий в другой комутатор. На таких линках появляется сообщения TCN и TCA - Topology Change Notificaton и
Topology Change Agreement с флагом proposal. Для обратной совместимости было введено состояние share - то есть стандартное STP состояние. Новый тип порта, значи -
тельно увеличив скорость работы: Edge - порт в который воткнут хост, такой порт сразу переходит в состояние Forwarding.

Состояния в RSTP:
1. Discarding - состояние, объеденившее первые три состоянии STP.
2. Learning - аналогично STP.
3. Forwarding - аналогично STP.

STP и RSTP не оперируют VLAN. В связи с этим, CISCO разработало своё проприетарное решение: PVST - Per-VLAN Spanning Tree. 
Изначально PVST работало на транках ISL. Затем появлися PVST+, работавший уже на dot1q транках. После появления RSTP, появился и Rapid PVST+ (RPVST+).
PVST строит дерево для каждого VLAN. Потому PVST медленный.
BID PVST представляет из себя такое же 64 разрядное число среди которых 4 бит для приоритета, 12 для VLAN и 48 для MAC-адреса. Такой BID назывался Extended ID(EID).
Так как в EID первые 16 бит рассматривались как единое число, то сам приоритет в PVST шёл с шагом в 4096.
Таким образом:
    Priority    VLAN
    0000        000000000000 - 0
    0001        000000000000 - 4096
    0010        000000000000 - 8192
    0010        000000000011 - 8195 
Так как протокол проприетарный, был разработан стандарт IEEE802.1s - протокол MSTP. MSTP в отличии от PVST требует меньше рессурсов. Это связано с вводом т. н. Instance.
В эти Instance помещаются VLAN. И в них строятся деревья, что сокращает количество деревьев от количества VLAN до количества Instance.

#show spanning-tree - выводит информацию о STP.
32768 - стандартный приоритет CISCO.
(config)#spanning-tree mode rapid-pvst - включает поддержку rpvst+
(config-if)#spanning-tree vlan 10 root primary - устанавливает приоритет 24576. Если установлен меньший приоритет, то вычтет из него 4096.
(config-if)#spanning-tree vlan 10 root secondary - устанавливает приоритет 28672.
(config-if)#spanning-tree pathcost method short/long - устанавливает размерность цен путей.
(config-if)#spanning-tree type share - устанавливает тип порта share
(config-if)#spanning-tree type portfast edge - устанавливает тип порта edge